let gender = 'male', style = 'pop', noiseGate = 'weak';
let delayDb = 0, reverbDb = 0; // å€‹åˆ¥ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ-4/0/+4ï¼‰
let lastObjectUrl = null;
let fileId = null;
let prevCtl = null;     // /process ç”¨ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«åˆ¶å¾¡
let inspectCtl = null;  // /inspect ç”¨ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«åˆ¶å¾¡   â† è¿½åŠ 
let bpmCommitted = null; // â† Enterã§ç¢ºå®šã•ã‚ŒãŸå€¤ã€‚nullãªã‚‰"æœªæŒ‡å®šï¼ã‚¹ã‚¿ã‚¤ãƒ«æ¨™æº–"
// æ—¢å­˜ã®å¤‰æ•°ã®å¾Œã«è¿½åŠ 
let lastProcessedBpm = null;
let bpmJustChanged = false;

// ã‚¯ãƒªãƒƒã‚¯é–“éš”åˆ¶é™ç”¨
let lastPresetClickTime = 0;
const MIN_PRESET_CLICK_INTERVAL = 100; // ãƒŸãƒªç§’ï¼ˆ100msã«çŸ­ç¸®ï¼‰

// â–¼ LA-2Aï¼ˆStage2ï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼ˆè§¦ã£ãŸæ™‚ã ã‘é€ã‚‹ï¼‰
let comp2TargetDb = null; // -3 / -7 / -10ã€æœªæ“ä½œã¯ null
let comp2Touched  = false; // ä¸€åº¦ã§ã‚‚è§¦ã£ãŸã‚‰ true
let reverbManuallySet = false; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ãƒªãƒãƒ¼ãƒ–ã‚’è¨­å®šã—ãŸã‹ã®ãƒ•ãƒ©ã‚°

// â–¼ Saturation ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼ˆè§¦ã£ãŸæ™‚ã ã‘é€ã‚‹ï¼‰
let satAmount  = null;   // 0.0ã€œ1.0ï¼ˆä¾‹ï¼š0.2 / 0.4 / 0.7ï¼‰ã€‚æœªæ“ä½œã¯ null
let satTouched = false;  // ä¸€åº¦ã§ã‚‚è§¦ã£ãŸã‚‰ true


// ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šå„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ON/OFFï¼ˆåˆæœŸã¯å…¨éƒ¨ONï¼‰- æ–°ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
let fxOn = {
  noise_gate: true, eq: true, comp1: true, comp2: true,
  deess: true, style_eq: true, saturation: true,  // æ–°æ©Ÿèƒ½è¿½åŠ 
  delay: true, reverb: true, limiter: true
};

// æ”¹å–„: Debounceç”¨ã®ã‚¿ã‚¤ãƒãƒ¼
let presetUpdateTimer = null;
let fxUpdateTimer = null;
let isUpdating = false;

// é€£æ‰“å¯¾ç­–ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œã‚’ç›´è¿‘1å›ã«é›†ç´„
let previewInFlight = false;
let previewDirty = false;

async function schedulePreview() {
  if (previewInFlight) { 
    previewDirty = true; 
    return; 
  }
  previewInFlight = true;
  try {
    await runPreviewIfPossible();   // æ—¢å­˜
  } catch (e) {
    if (e?.name !== 'AbortError') console.error(e);
  } finally {
    previewInFlight = false;
    if (previewDirty) {
      previewDirty = false;
      schedulePreview();            // æœ€æ–°çŠ¶æ…‹ã§ã‚‚ã†ä¸€åº¦ã ã‘
    }
  }
}

// é€²æ—è¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
async function setStatusWithDelay(message, delay = 100) {
  const status = document.getElementById('status');
  status.textContent = message;
  await new Promise(resolve => setTimeout(resolve, delay));
}

// === ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ç”¨ä¸­å¤®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡é–¢æ•° ===
function showPresetLoading() {
  console.log('[Debug] showPresetLoading called');
  const overlay = document.getElementById('preset_loading_overlay');
  if (overlay) {
    overlay.style.display = 'flex';
    console.log('[Debug] Preset loading overlay shown');
  } else {
    console.log('[Debug] Preset loading overlay not found!');
  }
}

function hidePresetLoading() {
  console.log('[Debug] hidePresetLoading called');
  const overlay = document.getElementById('preset_loading_overlay');
  if (overlay) {
    overlay.style.display = 'none';
    console.log('[Debug] Preset loading overlay hidden');
  }
}

// === æ—§ã‚·ãƒ³ãƒ—ãƒ«ã‚¹ãƒ”ãƒŠãƒ¼åˆ¶å¾¡é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰ ===
function showSpinner() {
  showPresetLoading();
}

function hideSpinner() {
  hidePresetLoading();
}

// ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
function testSpinner() {
  console.log('[Test] Testing preset loading visibility');
  showPresetLoading();
  setTimeout(() => {
    console.log('[Test] Hiding preset loading after 3 seconds');
    hidePresetLoading();
  }, 3000);
}

// çµ±ä¸€ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆåˆ¶å¾¡é–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
function setUnifiedGrayOut(enable = true, level = 'normal') {
  console.log(`[Debug] setUnifiedGrayOut called: enable=${enable}, level=${level}`);

  const sections = [
    'preset_section',
    'preview_section',
    'space_split_section'
  ];

  sections.forEach(sectionId => {
    const section = document.getElementById(sectionId);
    console.log(`[Debug] Section ${sectionId}:`, section ? 'Found' : 'NOT FOUND');
    if (!section) return;

    if (enable) {
      section.classList.add('disabled-section');
      console.log(`[Debug] Added disabled-section to ${sectionId}`);

      // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
      if (sectionId === 'preset_section') {
        showSpinner();
      }
    } else {
      section.classList.remove('disabled-section', 'light-disabled');
      console.log(`[Debug] Removed disabled-section from ${sectionId}`);

      // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã™
      if (sectionId === 'preset_section') {
        hideSpinner();
      }
    }
  });

  const audioEl = document.getElementById('preview_audio');
  const proToggle = document.getElementById('pro_glance');
  const proLabel = proToggle?.parentElement;

  if (audioEl) {
    if (enable) {
      audioEl.classList.add('disabled-audio');
      try { audioEl.pause(); } catch {}
      audioEl.currentTime = 0;
    } else {
      audioEl.classList.remove('disabled-audio');
    }
  }

  if (proLabel && proToggle) {
    if (enable) {
      proLabel.classList.add('disabled');
      proToggle.disabled = true;
    } else {
      proLabel.classList.remove('disabled');
      proToggle.disabled = false;
    }
  }
}

// BPMå€¤ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
function getBpmValue() {
  const bpmInput = document.getElementById('bpm_input');
  if (!bpmInput) return 120; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBPM
  
  const value = parseFloat(bpmInput.value);
  // BPMå€¤ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆ60-200ã®ç¯„å›²ï¼‰
  if (isNaN(value) || value < 60 || value > 200) {
    return 120; // ç„¡åŠ¹ãªå€¤ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  }
  return value;
}

// å…¥åŠ›æ¬„ã®"ä»Šæ‰“ã£ã¦ã„ã‚‹å€¤"ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚³ãƒŸãƒƒãƒˆã¯ã—ãªã„ï¼‰
function parseBpmRaw() {
  const el = document.getElementById('bpm_input');
  if (!el) return null;
  const raw = (el.value || '').trim();
  if (raw === '') return null;
  const v = parseFloat(raw);
  if (Number.isNaN(v) || v < 60 || v > 200) return null;
  return v;
}

// ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿BPMã‚’å–å¾—ï¼ˆnullãªã‚‰æœªæŒ‡å®šï¼ã‚¹ã‚¿ã‚¤ãƒ«æ¨™æº–ã§ã‚µãƒ¼ãƒè¨ˆç®—ï¼‰
function getBpmCommitted() {
  return bpmCommitted;
}

// Chorus ç³» or ï¼ˆä»Šå¾Œï¼‰ãƒ€ãƒ–ãƒ©ãƒ¼ONãªã‚‰ã‚¹ãƒ†ãƒ¬ã‚ªã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
function shouldForceStereoPreview() {
  const st = (style || '').toLowerCase();
  if (st.startsWith('chorus')) return true;        // 'chorus' / 'chorus_wide'
  if (fxOn && fxOn.doubler === true) return true;  // å°†æ¥ã®UIéœ²å‡ºç”¨ã®å¸ƒçŸ³ï¼ˆç¾çŠ¶ã¯æœªä½¿ç”¨ï¼‰
  return false;
}

// Enterã§"ç¢ºå®š"â†’ã“ã®æ™‚ã ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/FXä¸€è¦§ã‚’æ›´æ–°
async function commitBpmFromInput() {
  // â˜… BPMç¢ºå®šã‚‚ã‚¯ãƒªãƒƒã‚¯é–“éš”åˆ¶é™å¯¾è±¡ â˜…
  const now = Date.now();
  if (now - lastPresetClickTime < MIN_PRESET_CLICK_INTERVAL) {
    console.log(`[Protection] BPMå¤‰æ›´é–“éš”ãŒçŸ­ã™ãã¾ã™: ${now - lastPresetClickTime}ms`);
    return;
  }
  lastPresetClickTime = now;

  const v = parseBpmRaw();
  const oldBpm = bpmCommitted;
  bpmCommitted = v;
  
  // BPMãŒå®Ÿéš›ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
  if (oldBpm !== bpmCommitted) {
    bpmJustChanged = true;
    console.log(`BPM changed: ${oldBpm} â†’ ${bpmCommitted}`);
    setUnifiedGrayOut(true); // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºé–‹å§‹

    const startTime = Date.now();
    try {
      await runPreviewIfPossible();
      const proChk = document.getElementById('pro_glance');
      if (proChk?.checked) await fetchAndRenderFxList();

      // æœ€å°500msè¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã™
      const elapsed = Date.now() - startTime;
      if (elapsed < 500) {
        await new Promise(resolve => setTimeout(resolve, 500 - elapsed));
      }
    } finally {
      setUnifiedGrayOut(false); // å‡¦ç†å®Œäº†å¾Œã«ã‚¹ãƒ”ãƒŠãƒ¼éè¡¨ç¤º
    }
  } else {
    await runPreviewIfPossible();
    const proChk = document.getElementById('pro_glance');
    if (proChk?.checked) await fetchAndRenderFxList();
  }
}

function bindSeg(id, initial) {
  const box = document.getElementById(id);
  const btns = box.querySelectorAll('button');
  btns.forEach(b => {
    if (b.dataset.val === initial) {
      b.setAttribute('aria-selected', 'true');
    }
  });
}

// â–¼ è¿½åŠ ï¼šå°ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆé¸æŠçŠ¶æ…‹ã®ä»˜ã‘æ›¿ãˆï¼‰
function setSegSelected(id, val){
  const box = document.getElementById(id);
  if (!box) return;
  box.querySelectorAll('button[aria-selected="true"]').forEach(b=>b.removeAttribute('aria-selected'));
  const btn = box.querySelector(`button[data-val="${String(val)}"]`);
  if (btn) btn.setAttribute('aria-selected','true');
}

// â–¼ è¿½åŠ ï¼šã‚¹ã‚¿ã‚¤ãƒ«æ—¢å®šã®Compé‡ï¼ˆLA-2Aï¼‰
function compDefaultByStyle(s){
  const k = (s||'pop').toLowerCase();
  if (k === 'narration') return null; // narration ã®ã¿ Stage2 OFF
  return -7; // å…¨ã‚¹ã‚¿ã‚¤ãƒ«ã§ã€Œæ¨™æº–ã€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
}

function satDefaultByStyle(s){
  const k = (s||'pop').toLowerCase();
  if (k === 'narration') return 0.0; // narration ã®ã¿ã‚ªãƒ•
  return 0.4; // å…¨ã‚¹ã‚¿ã‚¤ãƒ«ã§ã€Œæ¨™æº–ã€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
}

// ã“ã“ã«æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ 
function getReverbDefaultByStyle(style) {
  const s = (style || 'pop').toLowerCase();
  if (s === 'rock') return 0;      // -14dB (æ¨™æº–)
  if (s === 'pop') return 0;       // -14dB (æ¨™æº–)  
  if (s === 'ballad') return 4;    // -10dB (å¼·ã‚)
  if (s === 'chorus') return 6;    // -8dB (ã¨ã¦ã‚‚å¼·ã„)
  if (s === 'chorus_wide') return 2; // -12dB (ã‚„ã‚„å¼·ã‚)
  return -8; // narration: -22dB (ã¨ã¦ã‚‚å¼±ã„)
}

function updateGlanceHeaders(h){
  const g1 = parseFloat(h.get('X-GR1-PEAK-DB')||'NaN');
  const g2 = parseFloat(h.get('X-GR2-PEAK-DB')||'NaN');
  const lufs = parseFloat(h.get('X-LUFS')||'NaN');
  const tp   = parseFloat(h.get('X-TP-DB')||'NaN');

  if(!Number.isNaN(g1)){
    document.getElementById('gr1_db').textContent = `GR: ${g1.toFixed(1)} dB`;
    document.getElementById('gr1_bar').style.width = `${Math.min(100, Math.max(0, (g1/12)*100))}%`;
  }
  if(!Number.isNaN(g2)){
    document.getElementById('gr2_db').textContent = `GR: ${g2.toFixed(1)} dB`;
    document.getElementById('gr2_bar').style.width = `${Math.min(100, Math.max(0, (g2/12)*100))}%`;
  }
  if(!Number.isNaN(lufs)) document.getElementById('lufs').textContent = `LUFS: ${lufs.toFixed(1)}`;
  if(!Number.isNaN(tp))   document.getElementById('tp').textContent   = `TP: ${tp.toFixed(1)} dBTP`;
}

// æ”¹å–„: ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ã®è»½é‡åŒ–é–¢æ•°
async function smartPreviewUpdate() {
  if (isUpdating) return;

  isUpdating = true;
  const status = document.getElementById('status');
  status.textContent = 'è¨­å®šå¤‰æ›´ã‚’å‡¦ç†ä¸­...';

  // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã¨ã‚¹ãƒ”ãƒŠãƒ¼ã‚’å³åº§ã«è¡¨ç¤º
  setUnifiedGrayOut(true);

  // debounceã§é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã‚’åˆ¶å¾¡
  clearTimeout(presetUpdateTimer);
  presetUpdateTimer = setTimeout(async () => {
    const startTime = Date.now();
    try {
      await setStatusWithDelay('ãƒ—ãƒªã‚»ãƒƒãƒˆæ›´æ–°ä¸­...', 50);
      const proChk = document.getElementById('pro_glance');
      if (proChk.checked) {
        await setStatusWithDelay('ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€è¦§æ›´æ–°ä¸­...', 50);
        await fetchAndRenderFxList();
      }
      await setStatusWithDelay('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™ä¸­...', 50);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤ï¼ˆschedulePreviewã‚’ä½¿ç”¨ï¼‰
      await schedulePreview();

      // æœ€å°500msè¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã™
      const elapsed = Date.now() - startTime;
      if (elapsed < 500) {
        await new Promise(resolve => setTimeout(resolve, 500 - elapsed));
      }

    } finally {
      isUpdating = false;
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†å®Œäº†å¾Œã«ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚’è§£é™¤
      setUnifiedGrayOut(false);
    }
  }, 200); // 200ms ã®debounce
}

// ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
window.emergencyReset = function() {
  console.log('ğŸš¨ Emergency reset triggered');
  hideProgress();
  hidePresetLoading();
  setUnifiedGrayOut(false);

  // å…¨ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
  if (typeof presetUpdateTimer !== 'undefined' && presetUpdateTimer) {
    clearTimeout(presetUpdateTimer);
  }
  if (typeof fxUpdateTimer !== 'undefined' && fxUpdateTimer) {
    clearTimeout(fxUpdateTimer);
  }

  // AbortControllerã‚‚ã‚¯ãƒªã‚¢
  if (typeof prevCtl !== 'undefined' && prevCtl) {
    prevCtl.abort();
    prevCtl = null;
  }
  if (typeof inspectCtl !== 'undefined' && inspectCtl) {
    inspectCtl.abort();
    inspectCtl = null;
  }

  // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
  const previewBtn = document.getElementById('preview');
  const downloadBtn = document.getElementById('download');
  if (previewBtn) previewBtn.disabled = false;
  if (downloadBtn) downloadBtn.disabled = false;

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚¯ãƒªã‚¢
  const status = document.getElementById('status');
  if (status) status.textContent = 'ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';

  console.log('âœ… Emergency reset completed');
};

window.addEventListener('DOMContentLoaded', ()=>{
  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å…¨ã¦ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  hideProgress();
  hidePresetLoading();
  setUnifiedGrayOut(false);

  bindSeg('gender_toggle', gender);
  bindSeg('style_toggle',  style);
  bindSeg('ng_toggle',     noiseGate);
  bindSeg('delay_space_toggle',  '0');
  bindSeg('reverb_space_toggle', '0');
  // â–¼ è¿½åŠ ï¼šè¦‹ãŸç›®ã ã‘ã‚¹ã‚¿ã‚¤ãƒ«æ—¢å®šã«ã—ã¦ãŠãï¼ˆæœªæ“ä½œï¼é€ä¿¡ã—ãªã„ï¼‰
  bindSeg('comp2_amount_toggle', String(compDefaultByStyle(style) ?? -7));
  bindSeg('sat_amount_toggle',   String(satDefaultByStyle(style))); // â† è¿½åŠ 

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€æ‹¬ã‚ªãƒ³ã‚ªãƒ•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå°ã•ã„ãƒœã‚¿ãƒ³ï¼‰
  const bulkAllOnBtn = document.getElementById('bulk_all_on');
  const bulkAllOffBtn = document.getElementById('bulk_all_off');

  if (bulkAllOnBtn) {
    bulkAllOnBtn.addEventListener('click', async () => {
      bulkAllOnBtn.disabled = true;
      bulkAllOffBtn.disabled = true;
      try {
        await toggleAllEffects(true);
      } catch (error) {
        console.error('å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆONã§ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        bulkAllOnBtn.disabled = false;
        bulkAllOffBtn.disabled = false;
      }
    });
  }

  if (bulkAllOffBtn) {
    bulkAllOffBtn.addEventListener('click', async () => {
      bulkAllOnBtn.disabled = true;
      bulkAllOffBtn.disabled = true;
      try {
        await toggleAllEffects(false);
      } catch (error) {
        console.error('å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆOFFã§ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        bulkAllOnBtn.disabled = false;
        bulkAllOffBtn.disabled = false;
      }
    });
  }
});

  const fileInput   = document.getElementById('file');
  const previewBtn  = document.getElementById('preview');
  const downloadBtn = document.getElementById('download');
  const status      = document.getElementById('status');
  const audioEl     = document.getElementById('preview_audio');

  function updatePreviewBtnByState() {
    if (!audioEl.src) {
      previewBtn.textContent = 'â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ';
      previewBtn.disabled = false;
      return;
    }
    if (audioEl.paused) previewBtn.textContent = 'â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ';
    else previewBtn.textContent = 'â¸ ä¸€æ™‚åœæ­¢';
  }
  window.updatePreviewBtnByState = updatePreviewBtnByState;

  audioEl.addEventListener('play',  updatePreviewBtnByState);
  audioEl.addEventListener('pause', updatePreviewBtnByState);
  audioEl.addEventListener('ended', () => { audioEl.currentTime = 0; updatePreviewBtnByState(); });
  updatePreviewBtnByState();
  audioEl.autoplay = false;

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ™‚ã®è‡ªå‹•å†ç”Ÿãƒ•ãƒ©ã‚°
let autoPlayOnUpdate = false;

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è‡ªå‹•å†ç”Ÿã®åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
function toggleAutoPlay() {
  autoPlayOnUpdate = !autoPlayOnUpdate;
  const status = document.getElementById('status');
  if (status) {
    status.textContent = `è‡ªå‹•å†ç”Ÿ: ${autoPlayOnUpdate ? 'ON' : 'OFF'}`;
  }
  console.log('[Debug] Auto-play toggled:', autoPlayOnUpdate);
}

// ãƒ‡ãƒãƒƒã‚°ç”¨: ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
function showCurrentState() {
  console.log('[Debug] Current state:', {
    gender, style, noiseGate,
    delayDb, reverbDb,
    fxOn,
    autoPlayOnUpdate
  });
}

// â˜… ãƒ†ã‚¹ãƒˆç”¨: ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨ãƒ†ã‚¹ãƒˆé–¢æ•° â˜…
function testPresetApplication() {
  console.log('=== ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');

  console.log('1. ç¾åœ¨ã®è¨­å®š:', {
    gender: gender,
    style: style,
    noiseGate: noiseGate
  });

  console.log('2. UIé¸æŠçŠ¶æ…‹:');
  const genderSelected = document.querySelector('#gender_toggle button[aria-selected="true"]')?.dataset?.val;
  const styleSelected = document.querySelector('#style_toggle button[aria-selected="true"]')?.dataset?.val;
  const ngSelected = document.querySelector('#ng_toggle button[aria-selected="true"]')?.dataset?.val;

  console.log('   UI Gender:', genderSelected);
  console.log('   UI Style:', styleSelected);
  console.log('   UI NoiseGate:', ngSelected);

  console.log('3. çŠ¶æ…‹ã¨UIã®ä¸€è‡´:', {
    gender_match: gender === genderSelected,
    style_match: style === styleSelected,
    noiseGate_match: noiseGate === ngSelected
  });

  console.log('=== ãƒ†ã‚¹ãƒˆå®Œäº† ===');
}

// â˜… ãƒ†ã‚¹ãƒˆç”¨: å€‹åˆ¥èª¿æ•´é©ç”¨ãƒ†ã‚¹ãƒˆé–¢æ•° â˜…
function testSpaceApplication() {
  console.log('=== å€‹åˆ¥èª¿æ•´é©ç”¨ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');

  console.log('1. ç¾åœ¨ã®è¨­å®š:', {
    delayDb: delayDb,
    reverbDb: reverbDb,
    comp2TargetDb: comp2TargetDb,
    satAmount: satAmount
  });

  console.log('2. UIé¸æŠçŠ¶æ…‹:');
  const delaySelected = document.querySelector('#delay_space_toggle button[aria-selected="true"]')?.dataset?.val;
  const reverbSelected = document.querySelector('#reverb_space_toggle button[aria-selected="true"]')?.dataset?.val;
  const comp2Selected = document.querySelector('#comp2_amount_toggle button[aria-selected="true"]')?.dataset?.val;
  const satSelected = document.querySelector('#sat_amount_toggle button[aria-selected="true"]')?.dataset?.val;

  console.log('   UI Delay:', delaySelected);
  console.log('   UI Reverb:', reverbSelected);
  console.log('   UI Comp2:', comp2Selected);
  console.log('   UI Saturation:', satSelected);

  console.log('3. çŠ¶æ…‹ã¨UIã®ä¸€è‡´:', {
    delay_match: delayDb === parseFloat(delaySelected),
    reverb_match: reverbDb === parseFloat(reverbSelected),
    comp2_match: comp2TargetDb === parseFloat(comp2Selected),
    sat_match: satAmount === parseFloat(satSelected)
  });

  console.log('4. è¨­å®šãƒ•ãƒ©ã‚°:', {
    comp2Touched: comp2Touched,
    satTouched: satTouched,
    reverbManuallySet: reverbManuallySet
  });

  console.log('=== ãƒ†ã‚¹ãƒˆå®Œäº† ===');
}

// â˜… ãƒ†ã‚¹ãƒˆç”¨: å€‹åˆ¥èª¿æ•´ãƒœã‚¿ãƒ³ã®å®Œå…¨ãƒ†ã‚¹ãƒˆ â˜…
function testSpaceButtonComprehensive() {
  console.log('========================================');
  console.log('ğŸ§ª å€‹åˆ¥èª¿æ•´ãƒœã‚¿ãƒ³å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹');
  console.log('========================================');

  // 1. ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª
  console.log('ğŸ“Š 1. ç¾åœ¨ã®å†…éƒ¨çŠ¶æ…‹:');
  console.log('   delayDb:', delayDb);
  console.log('   reverbDb:', reverbDb);
  console.log('   comp2TargetDb:', comp2TargetDb);
  console.log('   satAmount:', satAmount);
  console.log('   comp2Touched:', comp2Touched);
  console.log('   satTouched:', satTouched);
  console.log('   reverbManuallySet:', reverbManuallySet);

  // 2. UIçŠ¶æ…‹ç¢ºèª
  console.log('\nğŸ–±ï¸ 2. UIé¸æŠçŠ¶æ…‹:');
  const delayUI = document.querySelector('#delay_space_toggle button[aria-selected="true"]')?.dataset?.val;
  const reverbUI = document.querySelector('#reverb_space_toggle button[aria-selected="true"]')?.dataset?.val;
  const comp2UI = document.querySelector('#comp2_amount_toggle button[aria-selected="true"]')?.dataset?.val;
  const satUI = document.querySelector('#sat_amount_toggle button[aria-selected="true"]')?.dataset?.val;

  console.log('   UI Delay:', delayUI);
  console.log('   UI Reverb:', reverbUI);
  console.log('   UI Comp2:', comp2UI);
  console.log('   UI Saturation:', satUI);

  // 3. ä¸€è‡´ç¢ºèª
  console.log('\nâœ… 3. çŠ¶æ…‹ã¨UIä¸€è‡´ç¢ºèª:');
  const delayMatch = delayDb === parseFloat(delayUI);
  const reverbMatch = reverbDb === parseFloat(reverbUI);
  const comp2Match = comp2TargetDb === parseFloat(comp2UI);
  const satMatch = satAmount === parseFloat(satUI);

  console.log('   Delayä¸€è‡´:', delayMatch, `(${delayDb} vs ${delayUI})`);
  console.log('   Reverbä¸€è‡´:', reverbMatch, `(${reverbDb} vs ${reverbUI})`);
  console.log('   Comp2ä¸€è‡´:', comp2Match, `(${comp2TargetDb} vs ${comp2UI})`);
  console.log('   Saturationä¸€è‡´:', satMatch, `(${satAmount} vs ${satUI})`);

  // 4. FormDataé€ä¿¡äºˆæ¸¬
  console.log('\nğŸ“¤ 4. FormDataé€ä¿¡äºˆæ¸¬:');
  console.log('   delay_offset_db: å¿…ãšé€ä¿¡ =', delayDb);
  console.log('   reverb_offset_db: å¿…ãšé€ä¿¡ =', reverbDb);
  console.log('   comp2_offset_db:', comp2Touched ? `é€ä¿¡äºˆå®š = ${comp2TargetDb}` : 'é€ä¿¡ã•ã‚Œãªã„ (æœªæ“ä½œ)');
  console.log('   sat_amount:', satTouched ? `é€ä¿¡äºˆå®š = ${satAmount}` : 'é€ä¿¡ã•ã‚Œãªã„ (æœªæ“ä½œ)');

  // 5. ãƒœã‚¿ãƒ³å­˜åœ¨ç¢ºèª
  console.log('\nğŸ”˜ 5. ãƒœã‚¿ãƒ³å­˜åœ¨ç¢ºèª:');
  const spaceButton = document.getElementById('space_apply');
  console.log('   å€‹åˆ¥èª¿æ•´é©ç”¨ãƒœã‚¿ãƒ³:', spaceButton ? 'âœ… å­˜åœ¨' : 'âŒ è¦‹ã¤ã‹ã‚‰ãªã„');

  // 6. ç·åˆåˆ¤å®š
  console.log('\nğŸ¯ 6. ç·åˆåˆ¤å®š:');
  const allMatched = delayMatch && reverbMatch && comp2Match && satMatch;
  const buttonExists = !!spaceButton;
  const readyForTest = allMatched && buttonExists;

  console.log('   å…¨è¨­å®šä¸€è‡´:', allMatched ? 'âœ… OK' : 'âŒ NG');
  console.log('   ãƒœã‚¿ãƒ³æº–å‚™:', buttonExists ? 'âœ… OK' : 'âŒ NG');
  console.log('   ãƒ†ã‚¹ãƒˆæº–å‚™:', readyForTest ? 'ğŸŸ¢ å®Œäº†' : 'ğŸ”´ å•é¡Œã‚ã‚Š');

  if (readyForTest) {
    console.log('\nğŸš€ ãƒ†ã‚¹ãƒˆæ¨å¥¨: å€‹åˆ¥èª¿æ•´é©ç”¨ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
  } else {
    console.log('\nâš ï¸ æ³¨æ„: è¨­å®šã¾ãŸã¯ãƒœã‚¿ãƒ³ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
  }

  console.log('========================================');
  console.log('ğŸ§ª å€‹åˆ¥èª¿æ•´ãƒœã‚¿ãƒ³å®Œå…¨ãƒ†ã‚¹ãƒˆå®Œäº†');
  console.log('========================================');
}

// === ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆåˆ¶å¾¡é–¢æ•° ===
function enableAllSections() {
  setUnifiedGrayOut(false);
}

function disableAllSections() {
  setUnifiedGrayOut(true);
}

// === ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆ¶å¾¡é–¢æ•° ===
let progressStartTime = null;
let progressTimer = null;

function showProgress(title = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...', text = 'ãŠå¾…ã¡ãã ã•ã„...', progress = 0) {
  const overlay = document.getElementById('progress_overlay');
  const titleEl = document.getElementById('progress_title');
  const textEl = document.getElementById('progress_text');
  const barEl = document.getElementById('progress_bar');
  const percentageEl = document.getElementById('progress_percentage');
  const currentStageEl = document.getElementById('current_stage');

  // é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
  progressStartTime = Date.now();

  if (overlay) overlay.style.display = 'flex';
  if (titleEl) titleEl.textContent = title;
  if (textEl) textEl.textContent = text;
  if (barEl) barEl.style.width = `${progress}%`;
  if (percentageEl) percentageEl.textContent = `${Math.round(progress)}%`;
  if (currentStageEl) currentStageEl.textContent = '1/5';

  // æ®µéšãƒ‰ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  resetStages();

  // æ™‚é–“æ›´æ–°ã‚’é–‹å§‹
  startTimeUpdater();
}

function updateProgress(progress, text = null, title = null, stage = null) {
  const titleEl = document.getElementById('progress_title');
  const textEl = document.getElementById('progress_text');
  const barEl = document.getElementById('progress_bar');
  const percentageEl = document.getElementById('progress_percentage');
  const currentStageEl = document.getElementById('current_stage');

  if (barEl) barEl.style.width = `${progress}%`;
  if (percentageEl) percentageEl.textContent = `${Math.round(progress)}%`;
  if (text && textEl) textEl.textContent = text;
  if (title && titleEl) titleEl.textContent = title;
  if (stage && currentStageEl) currentStageEl.textContent = `${stage}/5`;

  // æ®µéšãƒ‰ãƒƒãƒˆã‚’æ›´æ–°
  updateStages(progress);
}

function hideProgress() {
  const overlay = document.getElementById('progress_overlay');
  if (overlay) overlay.style.display = 'none';

  // æ™‚é–“æ›´æ–°ã‚’åœæ­¢
  stopTimeUpdater();

  // æ®µéšã‚’ãƒªã‚»ãƒƒãƒˆ
  resetStages();
}

// æ®µéšãƒ‰ãƒƒãƒˆåˆ¶å¾¡
function resetStages() {
  const stageDots = document.querySelectorAll('.stage-dot');
  stageDots.forEach(dot => {
    dot.classList.remove('active', 'completed');
  });
}

function updateStages(progress) {
  const stageDots = document.querySelectorAll('.stage-dot');
  const stageProgress = [0, 20, 40, 60, 80, 100];

  stageDots.forEach((dot, index) => {
    const stageValue = stageProgress[index];
    dot.classList.remove('active', 'completed');

    if (progress > stageValue) {
      dot.classList.add('completed');
    } else if (progress >= stageValue - 10) {
      dot.classList.add('active');
    }
  });
}

// æ™‚é–“æ›´æ–°æ©Ÿèƒ½
function startTimeUpdater() {
  stopTimeUpdater(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢

  progressTimer = setInterval(() => {
    if (progressStartTime) {
      const elapsed = Date.now() - progressStartTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      const timeEl = document.getElementById('elapsed_time');
      if (timeEl) timeEl.textContent = timeString;
    }
  }, 1000);
}

function stopTimeUpdater() {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
}

// å‡¦ç†ã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
function setProgressProcessingType(type) {
  const container = document.querySelector('.progress-container');
  if (container) {
    container.className = 'progress-container';
    if (type) {
      container.classList.add(type);
    }
  }
}

// === #1: ä¸€åº¦ã ã‘ /uploadï¼ˆä»¥å¾Œ file_id ã‚’ä½¿ã†ï¼‰ ===
fileInput.addEventListener('change', async ()=>{
    try { audioEl.pause(); } catch {}
    audioEl.currentTime = 0;
    updatePreviewBtnByState();

    // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã¯åˆå›æ‰±ã„ã«ãƒªã‚»ãƒƒãƒˆ
    lastProcessedBpm = null;
    bpmJustChanged = false;
    reverbManuallySet = false; // ãƒªãƒãƒ¼ãƒ–æ‰‹å‹•è¨­å®šãƒ•ãƒ©ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ

    fileId = null;
    const f = fileInput.files?.[0];
    if(!f){
      status.textContent='ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
      disableAllSections(); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å†åº¦ç„¡åŠ¹åŒ–
      hideProgress(); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éš ã™
      return;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ›
    console.log('ğŸ” Selected file details:', {
      name: f.name,
      size: f.size,
      type: f.type,
      lastModified: f.lastModified,
      lastModifiedDate: f.lastModifiedDate,
      webkitRelativePath: f.webkitRelativePath,
      userAgent: navigator.userAgent,
      isMobile: /Mobi|Android/i.test(navigator.userAgent)
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒãƒ›ç”¨åˆ¶é™ï¼‰
    const maxSize = /Mobi|Android/i.test(navigator.userAgent) ? 20 * 1024 * 1024 : 50 * 1024 * 1024; // ã‚¹ãƒãƒ›ã¯20MBã€PCã¯50MB
    if (f.size > maxSize) {
      hideProgress();
      status.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ${Math.round(maxSize / 1024 / 1024)}MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰`;
      disableAllSections();
      return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
    const fileName = f.name.toLowerCase();
    const hasWavExtension = fileName.endsWith('.wav');
    const hasM4aExtension = fileName.endsWith('.m4a');
    const hasMp3Extension = fileName.endsWith('.mp3');
    const hasAacExtension = fileName.endsWith('.aac');
    const hasSupportedExtension = hasWavExtension || hasM4aExtension || hasMp3Extension || hasAacExtension;
    const hasAudioType = f.type && f.type.startsWith('audio');

    if (!f.type && !hasSupportedExtension) {
      console.warn('âš ï¸ File type not detected, checking by extension');
      if (!hasSupportedExtension) {
        hideProgress();
        hidePresetLoading();
        setUnifiedGrayOut(false);
        status.textContent = 'éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆWAV, M4A, MP3, AACï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
        disableAllSections();
        return;
      }
    }

    // Dropboxç‰¹æœ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«åå•é¡Œãƒã‚§ãƒƒã‚¯
    if (f.name.length > 50 && /^[A-F0-9]+/.test(f.name) && !hasSupportedExtension) {
      console.warn('âš ï¸ Possible Dropbox temporary filename detected:', f.name);
      if (!hasAudioType) {
        hideProgress();
        hidePresetLoading();
        setUnifiedGrayOut(false);
        status.textContent = 'Dropboxã‹ã‚‰æ­£ã—ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠè©¦ã—ãã ã•ã„';
        disableAllSections();
        return;
      }
    }

    // Dropboxç‰¹æœ‰ã®å•é¡Œãƒã‚§ãƒƒã‚¯
    if (f.size === 0) {
      console.error('âŒ File size is 0 - possible Dropbox streaming issue');
      hideProgress();
      status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Dropboxã‹ã‚‰ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠè©¦ã—ãã ã•ã„';
      disableAllSections();
      return;
    }
    
    // ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–‹å§‹
    showProgress('ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 0);
    setProgressProcessingType('processing');

    await new Promise(resolve => setTimeout(resolve, 150)); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤ºå¾…ã¡

    // æ®µéšçš„ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°ï¼ˆã‚ˆã‚Šè©³ç´°ã«ï¼‰
    updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªä¸­...', null, 1);
    await new Promise(resolve => setTimeout(resolve, 200));

    updateProgress(20, 'ã‚µãƒ¼ãƒãƒ¼ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', null, 1);
    await new Promise(resolve => setTimeout(resolve, 300));

    const fd = new FormData();

    // FormDataè¿½åŠ å‰ã®ãƒ‡ãƒãƒƒã‚°
    console.log('ğŸ“¤ Preparing FormData...');
    try {
      fd.append('file', f);
      console.log('âœ… FormData created successfully');
    } catch (e) {
      console.error('âŒ FormData creation failed:', e);
      hideProgress();
      hidePresetLoading(); // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã‚‚ç¢ºå®Ÿã«éš ã™
      setUnifiedGrayOut(false); // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚‚è§£é™¤
      status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ';
      disableAllSections();
      return;
    }

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ç”¨
    const uploadController = new AbortController();
    const uploadTimeout = setTimeout(() => {
      console.error('âŒ Upload timeout (30s)');
      uploadController.abort();
    }, 30000); // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

    try{
      updateProgress(35, 'éŸ³å£°è§£æã‚’é–‹å§‹ä¸­...', null, 2);
      setProgressProcessingType('analyzing');
      console.time("ğŸ“¤ /upload fetch");
      console.log('ğŸ“¤ Starting upload request...');

      const res = await fetch('/upload', {
        method: 'POST',
        body: fd,
        cache: 'no-store',
        signal: uploadController.signal
      });

      clearTimeout(uploadTimeout);
      console.timeEnd("ğŸ“¤ /upload fetch");
      console.log('ğŸ“¤ Upload response received:', {
        ok: res.ok,
        status: res.status,
        statusText: res.statusText,
        headers: Object.fromEntries(res.headers.entries())
      });

      if(!res.ok){
        hideProgress();
        hidePresetLoading(); // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã‚‚ç¢ºå®Ÿã«éš ã™
        setUnifiedGrayOut(false); // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚‚è§£é™¤
        status.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— (${res.status})`;
        disableAllSections();
        return;
      }

      updateProgress(55, 'éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...', null, 3);
      await new Promise(resolve => setTimeout(resolve, 200));

      const j = await res.json();
      fileId = j.file_id;

      updateProgress(75, 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', null, 4);
      setProgressProcessingType('rendering');
      await new Promise(resolve => setTimeout(resolve, 250));

      updateProgress(90, 'æœ€çµ‚èª¿æ•´ä¸­...', null, 5);
      await new Promise(resolve => setTimeout(resolve, 200));

      await runPreviewIfPossible();
    }catch(e){
      clearTimeout(uploadTimeout);
      console.error('âŒ Upload error details:', {
        name: e.name,
        message: e.message,
        stack: e.stack
      });

      hideProgress();
      hidePresetLoading(); // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã‚‚ç¢ºå®Ÿã«éš ã™
      setUnifiedGrayOut(false); // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚‚è§£é™¤

      // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (e.name === 'AbortError') {
        status.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰';
      } else if (e.message.includes('Failed to fetch')) {
        status.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰';
      } else if (e.message.includes('NetworkError')) {
        status.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¾ãŸã¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
      } else {
        status.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${e.message}`;
      }

      disableAllSections(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç„¡åŠ¹åŒ–
    }
  });

  // ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰
  const proChk   = document.getElementById('pro_glance');
  const compCard = document.getElementById('comp_glance');
  const fxCard   = document.getElementById('fx_list');

  proChk.addEventListener('change', async ()=>{
    const on = proChk.checked;
    compCard.hidden = !on;
    fxCard.hidden   = !on;

    if (!on) return;

    try {
      await setStatusWithDelay('ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæƒ…å ±å–å¾—ä¸­...', 50);
      await fetchAndRenderFxList();
    } catch (e) {
      console.error('Pro mode init failed:', e);
      const statusEl = document.getElementById('status');
      if (statusEl) statusEl.textContent = 'ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
    } finally {
      // ã€Œå–å¾—ä¸­â€¦ã€ã¯å¿…ãšæ¶ˆã™
      const statusEl = document.getElementById('status');
      if (statusEl && statusEl.textContent.includes('ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæƒ…å ±')) {
        statusEl.textContent = '';
      }
    }
  });

// å·¦ã‚«ãƒ©ãƒ ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šï¼ˆä¸€æ‹¬é©ç”¨æ–¹å¼ï¼‰
['gender_toggle','style_toggle','ng_toggle'].forEach(id=>{
  const box = document.getElementById(id);
  box.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if (!btn) return;
    if (btn.getAttribute('aria-selected') === 'true') return;

    // UIæ›´æ–°ã®ã¿ï¼ˆå³åº§ã«å‡¦ç†ã¯å®Ÿè¡Œã—ãªã„ï¼‰
    box.querySelectorAll('button[aria-selected="true"]').forEach(b=>b.removeAttribute('aria-selected'));
    btn.setAttribute('aria-selected','true');

    const val = btn.dataset.val;

    // çŠ¶æ…‹æ›´æ–°ã®ã¿ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®Ÿè¡Œã—ãªã„ï¼‰
    if (id === 'gender_toggle') {
      gender = val;
    } else if (id === 'style_toggle') {
      style = val;
      // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´æ™‚ã¯å³ã‚«ãƒ©ãƒ ã®å…¨è¨­å®šã‚’å¼·åˆ¶çš„ã«æ¨™æº–ã«ãƒªã‚»ãƒƒãƒˆ
      delayDb = 0;
      reverbDb = 0;
      comp2TargetDb = compDefaultByStyle(style) ?? -7;
      satAmount = satDefaultByStyle(style);

      // å…¨ã¦ã®ãƒ•ãƒ©ã‚°ã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
      comp2Touched = false;
      satTouched = false;
      reverbManuallySet = false;

      // UIè¡¨ç¤ºã‚’ã™ã¹ã¦æ¨™æº–ã«æ›´æ–°
      setSegSelected('delay_space_toggle', '0');
      setSegSelected('reverb_space_toggle', '0');
      setSegSelected('comp2_amount_toggle', String(comp2TargetDb));
      setSegSelected('sat_amount_toggle', String(satAmount));

      console.log('[Debug] Style changed - ALL right column controls force reset to standard');
    } else if (id === 'ng_toggle') {
      noiseGate = val;
    }

    console.log(`[Debug] Preset setting changed: ${id} = ${val} (not applied yet)`);

    // â˜… è¨­å®šå¤‰æ›´å¾Œã®çŠ¶æ…‹ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
    console.log('[Test] Updated preset state:', {
      gender: gender,
      style: style,
      noiseGate: noiseGate
    });
  });
});

// å³ã‚«ãƒ©ãƒ è¨­å®šï¼ˆä¸€æ‹¬é©ç”¨æ–¹å¼ã«å¤‰æ›´ï¼‰
['delay_space_toggle','reverb_space_toggle','comp2_amount_toggle','sat_amount_toggle'].forEach(id=>{
  const box = document.getElementById(id);
  box.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if (!btn) return;
    if (btn.getAttribute('aria-selected') === 'true') return;

    // UIæ›´æ–°ã®ã¿ï¼ˆå³åº§ã«å‡¦ç†ã¯å®Ÿè¡Œã—ãªã„ï¼‰
    box.querySelectorAll('button[aria-selected="true"]').forEach(b=>b.removeAttribute('aria-selected'));
    btn.setAttribute('aria-selected','true');

    const val = btn.dataset.val;

    // çŠ¶æ…‹æ›´æ–°ã®ã¿ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®Ÿè¡Œã—ãªã„ï¼‰
    if (id === 'delay_space_toggle') {
      delayDb = parseFloat(val) || 0;
    } else if (id === 'reverb_space_toggle') {
      reverbDb = parseFloat(val) || 0;
      reverbManuallySet = true;
      console.log('[Debug] Manual reverb set to', reverbDb);
    } else if (id === 'comp2_amount_toggle') {
      comp2TargetDb = parseFloat(val);
      comp2Touched = true;
    } else if (id === 'sat_amount_toggle') {
      satAmount = parseFloat(val);
      satTouched = true;
      console.log(`[Debug] Saturation amount set: ${satAmount}, touched: ${satTouched}`);
    }

    console.log(`[Debug] Space setting changed: ${id} = ${val} (not applied yet)`);

    // â˜… è¨­å®šå¤‰æ›´å¾Œã®çŠ¶æ…‹ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
    console.log('[Test] Updated space settings:', {
      delayDb: delayDb,
      reverbDb: reverbDb,
      comp2TargetDb: comp2TargetDb,
      satAmount: satAmount
    });
  });
});

// BPMå…¥åŠ›ï¼ˆEnterç¢ºå®šæ–¹å¼ï¼‰
const bpmInput = document.getElementById('bpm_input');
if (bpmInput) {
  // å…¥åŠ›ä¸­ã¯è¦‹ãŸç›®ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†ã¯èµ°ã‚‰ã›ãªã„ï¼‰
  bpmInput.addEventListener('input', () => {
    const v = parseBpmRaw(); // â† æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
    if (bpmInput.value.trim() !== '' && v === null) {
      bpmInput.style.borderColor = '#f87171';
      status.textContent = 'BPMã¯60ï½200ã€ç©ºæ¬„ã¯ã‚¹ã‚¿ã‚¤ãƒ«æ¨™æº–ã§ã™';
    } else {
      bpmInput.style.borderColor = '#374151';
      if (status.textContent.includes('BPM')) status.textContent = '';
    }
  });

// ã€Œé©ç”¨ã€ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›å‘ã‘ç¢ºå®šUIï¼šEnterã¨åŒç­‰ï¼‰
const bpmApply = document.getElementById('bpm_apply');
if (bpmApply) {
  bpmApply.addEventListener('click', async () => {
    try { audioEl.pause(); } catch {}
    audioEl.currentTime = 0;
    await commitBpmFromInput(); // æ—¢å­˜ã®ç¢ºå®šâ†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/FXæ›´æ–°
  });
}

// å·¦ã‚«ãƒ©ãƒ ä¸€æ‹¬é©ç”¨ãƒœã‚¿ãƒ³
const presetApply = document.getElementById('preset_apply');
if (presetApply) {
  presetApply.addEventListener('click', async () => {
    // â˜… ã‚¯ãƒªãƒƒã‚¯é–“éš”åˆ¶é™ãƒã‚§ãƒƒã‚¯ â˜…
    const now = Date.now();
    if (now - lastPresetClickTime < MIN_PRESET_CLICK_INTERVAL) {
      console.log(`[Protection] ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨é–“éš”ãŒçŸ­ã™ãã¾ã™: ${now - lastPresetClickTime}ms`);
      return;
    }
    lastPresetClickTime = now;

    console.log('[Debug] Applying left column preset settings...');

    // â˜… ç¾åœ¨ã®è¨­å®šå€¤ã‚’ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
    console.log('[Test] Current preset settings:', {
      gender: gender,
      style: style,
      noiseGate: noiseGate,
      delayDb: delayDb,
      reverbDb: reverbDb,
      comp2TargetDb: comp2TargetDb,
      satAmount: satAmount
    });

    // éŸ³å£°åœæ­¢
    try { audioEl.pause(); } catch {}
    audioEl.currentTime = 0;

    // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
    setUnifiedGrayOut(true);

    const startTime = Date.now();
    try {
      await runPreviewIfPossible();
      const proChk = document.getElementById('pro_glance');
      if (proChk?.checked) await fetchAndRenderFxList();

      // æœ€å°500msè¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã™
      const elapsed = Date.now() - startTime;
      if (elapsed < 500) {
        await new Promise(resolve => setTimeout(resolve, 500 - elapsed));
      }
    } finally {
      setUnifiedGrayOut(false);
    }
  });
}

// å³ã‚«ãƒ©ãƒ ï¼ˆå€‹åˆ¥èª¿æ•´ï¼‰ä¸€æ‹¬é©ç”¨ãƒœã‚¿ãƒ³
const spaceApply = document.getElementById('space_apply');
if (spaceApply) {
  spaceApply.addEventListener('click', async () => {
    // â˜… ã‚¯ãƒªãƒƒã‚¯é–“éš”åˆ¶é™ãƒã‚§ãƒƒã‚¯ â˜…
    const now = Date.now();
    if (now - lastPresetClickTime < MIN_PRESET_CLICK_INTERVAL) {
      console.log(`[Protection] å€‹åˆ¥èª¿æ•´é©ç”¨é–“éš”ãŒçŸ­ã™ãã¾ã™: ${now - lastPresetClickTime}ms`);
      return;
    }
    lastPresetClickTime = now;

    console.log('[Debug] Applying right column space settings...');

    // â˜… ç¾åœ¨ã®å€‹åˆ¥èª¿æ•´è¨­å®šå€¤ã‚’ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
    console.log('[Test] Current space settings:', {
      delayDb: delayDb,
      reverbDb: reverbDb,
      comp2TargetDb: comp2TargetDb,
      satAmount: satAmount,
      comp2Touched: comp2Touched,
      satTouched: satTouched,
      reverbManuallySet: reverbManuallySet
    });

    // éŸ³å£°åœæ­¢
    try { audioEl.pause(); } catch {}
    audioEl.currentTime = 0;

    // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
    setUnifiedGrayOut(true);

    const startTime = Date.now();
    try {
      await runPreviewIfPossible();
      const proChk = document.getElementById('pro_glance');
      if (proChk?.checked) await fetchAndRenderFxList();

      // æœ€å°500msè¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éš ã™
      const elapsed = Date.now() - startTime;
      if (elapsed < 500) {
        await new Promise(resolve => setTimeout(resolve, 500 - elapsed));
      }
    } finally {
      setUnifiedGrayOut(false);
    }
  });
}

  // Enterã§"ç¢ºå®š"â†’ã“ã“ã§ã ã‘å†è¨ˆç®—
  bpmInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      try { audioEl.pause(); } catch {}
      audioEl.currentTime = 0;
      await commitBpmFromInput();
    }
  });

  // blur ã§ã¯ç¢ºå®šã—ãªã„ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã§ commitBpmFromInput() ã‚’å‘¼ã¶é‹ç”¨ã«å¤‰æ›´å¯ï¼‰
}

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ
  previewBtn.addEventListener('click', async (e) => {
    if (!audioEl.src) await runPreviewIfPossible();
    if (!audioEl.src) return;

    if (e.shiftKey) { try { audioEl.pause(); } catch {}; audioEl.currentTime = 0; try { await audioEl.play(); } catch {}; return; }
    if (audioEl.paused) { try { await audioEl.play(); } catch {} }
    else { try { audioEl.pause(); } catch {} }
  });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆfile_id å„ªå…ˆï¼‰+ BPMå€¤ã®é€ä¿¡
    downloadBtn.addEventListener('click', async ()=>{
    // ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–‹å§‹
    showProgress('ğŸ§ é«˜å“è³ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ã‚’ã—ã¦ã„ã¾ã™...', 0);
    setProgressProcessingType('rendering');

    // çµ±ä¸€ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆé©ç”¨
    setUnifiedGrayOut(true);

    previewBtn.disabled = true; downloadBtn.disabled = true;

    await new Promise(resolve => setTimeout(resolve, 100)); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤ºå¾…ã¡

    const fd = new FormData();
    if (fileId) {
      fd.append('file_id', fileId);
      updateProgress(10, 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­...', null, 1);
    } else {
      const f = fileInput.files?.[0];
      if (f) {
        fd.append('file', f);
        updateProgress(10, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', null, 1);
      } else {
        hideProgress();
        status.textContent='éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„';
        previewBtn.disabled = false; downloadBtn.disabled = false;
        setUnifiedGrayOut(false);
        return;
      }
    }
    await new Promise(resolve => setTimeout(resolve, 200));
    
fd.append('gender', gender);
fd.append('style',  style);
fd.append('noise_gate', noiseGate);
fd.append('fx_on', JSON.stringify(fxOn));
fd.append('mode', 'download');

// Enterã§ç¢ºå®šã—ãŸæ™‚ã ã‘é€ã‚‹
const b = getBpmCommitted();
if (b !== null) fd.append('bpm', String(b));

// ã‚³ãƒ³ãƒ—é‡èª¿æ•´ï¼ˆå³ã‚«ãƒ©ãƒ æ–¹å¼ï¼‰
if (comp2Touched && comp2TargetDb !== null) {
  const def = compDefaultByStyle(style); // ã‚¹ã‚¿ã‚¤ãƒ«ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGR
  if (def !== null) {
    const offset = comp2TargetDb - def;
    fd.append('comp2_offset_db', String(offset));
    console.log(`[Debug] Sent comp2_offset_db = ${offset} (target=${comp2TargetDb}, default=${def})`);
  }
}

// â–¼ ã“ã“ã«è¿½åŠ ï¼šSaturation é‡ï¼ˆè§¦ã£ãŸæ™‚ã ã‘ï¼‰
if (satTouched && typeof satAmount === 'number') {
  fd.append('sat_amount', String(satAmount)); // ä¾‹ï¼š0.2 / 0.4 / 0.7
  console.log(`[Debug] Sending sat_amount: ${satAmount}`);
} else {
  console.log(`[Debug] Saturation not sent: touched=${satTouched}, amount=${satAmount}`);
}

fd.append('delay_offset_db',  String(delayDb));
fd.append('reverb_offset_db', String(reverbDb));

console.log('[Debug] Reverb settings - style:', style, 'reverbDb:', reverbDb);

// ãƒ€ãƒ–ãƒ©ãƒ¼è¨­å®šã‚’è¿½åŠ 
const currentStyle = (style || '').toLowerCase();
const isChorusStyle = currentStyle === 'chorus' || currentStyle === 'chorus_wide';
if (isChorusStyle) {
  fd.append('enable_doubler', '1');
  console.log('[Debug] Doubler enabled for style:', style);
} else {
  fd.append('enable_doubler', '0');
  console.log('[Debug] Doubler disabled for style:', style);
}

// æ—¢å­˜ã®è¡Œã¯ãã®ã¾ã¾
fd.append('force_stereo', shouldForceStereoPreview() ? '1' : '0');

    try{
      // æ®µéšçš„ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      updateProgress(25, 'ãƒ‰ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã‚’å‡¦ç†ä¸­...', null, 2);
      await new Promise(resolve => setTimeout(resolve, 150));

      updateProgress(40, 'ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨ä¸­...', null, 3);
      await new Promise(resolve => setTimeout(resolve, 200));

      updateProgress(55, 'ã‚¹ã‚¿ã‚¤ãƒ«EQã‚’èª¿æ•´ä¸­...', null, 3);
      await new Promise(resolve => setTimeout(resolve, 100));

      updateProgress(65, 'ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ä¸­...', null, 4);
      await new Promise(resolve => setTimeout(resolve, 100));

      updateProgress(75, 'ãƒ‡ã‚£ãƒ¬ã‚¤åŒæœŸã‚’é©ç”¨ä¸­...', null, 4);
      setProgressProcessingType('processing');
      await new Promise(resolve => setTimeout(resolve, 150));

      updateProgress(85, 'é«˜å“è³ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...', null, 5);
      await new Promise(resolve => setTimeout(resolve, 200));

      const res = await fetch('/process', { method:'POST', body: fd, cache:'no-store' });
      if(!res.ok){
        hideProgress();
        status.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status})`;
        return;
      }

      updateProgress(92, 'ãƒ©ã‚¦ãƒ‰ãƒã‚¹èª¿æ•´ä¸­...', null, 5);
      updateGlanceHeaders(res.headers);
      await new Promise(resolve => setTimeout(resolve, 100));

      updateProgress(98, 'ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...', 'ğŸ‰ å®Œäº†ã¾ã§ã‚ã¨å°‘ã—ï¼', 5);
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = Object.assign(document.createElement('a'), { href:url, download:'MixMate_out.wav' });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      updateProgress(100, 'âœ¨ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼', 'ğŸ§ é«˜å“è³ªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ', 5);
      await new Promise(resolve => setTimeout(resolve, 1000)); // å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
      hideProgress();
      status.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
    }catch(e){
      console.error(e);
      hideProgress();
      status.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    }finally{
      previewBtn.disabled = false; downloadBtn.disabled = false;
      setUnifiedGrayOut(false); // â† ã“ã®1è¡Œã‚’è¿½åŠ 
      const proChk = document.getElementById('pro_glance');
      if (proChk.checked) { 
        await setStatusWithDelay('ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæƒ…å ±æ›´æ–°ä¸­...', 50);
        await fetchAndRenderFxList(); 
      }
    }
  });

// ---- ç›´è¿‘ã ã‘æœ‰åŠ¹ï¼ˆAbortControllerï¼‰ ï¼‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯åŠåˆ†ãƒ¬ãƒ¼ãƒˆï¼ˆã‚µãƒ¼ãƒå´ã§è‡ªå‹•é©ç”¨ï¼‰ + BPMå€¤é€ä¿¡ ----
async function runPreviewIfPossible(){
  const status   = document.getElementById('status');
  const audioEl  = document.getElementById('preview_audio');
  const preview  = document.getElementById('preview');
  const download = document.getElementById('download');
  const fileInput = document.getElementById('file');

  // file_id ã‚‚ file ã‚‚ç„¡ã„ãªã‚‰ä½•ã‚‚ã—ãªã„
  const f = fileInput.files?.[0];
  if (!fileId && !f) return;

  try { audioEl.pause(); } catch {}
  audioEl.currentTime = 0;

  // é€²æ—è¡¨ç¤ºä»˜ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
  await setStatusWithDelay('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™ä¸­...', 50);
  preview.disabled = true; download.disabled = true;

  if (prevCtl) prevCtl.abort();
  prevCtl = new AbortController();

  const fd = new FormData();
  if (fileId) {
    fd.append('file_id', fileId);
    await setStatusWithDelay('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªä¸­...', 50);
  } else if (f) {
    fd.append('file', f);
    await setStatusWithDelay('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...', 50);
  }
  
fd.append('gender', gender);
fd.append('style',  style);
fd.append('noise_gate', noiseGate);
fd.append('fx_on', JSON.stringify(fxOn));
fd.append('mode', 'preview');

// â˜… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§é€ä¿¡ã•ã‚Œã‚‹è¨­å®šå€¤ã‚’ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
console.log('[Test] Preview FormData values:', {
  gender: gender,
  style: style,
  noise_gate: noiseGate,
  delayDb: delayDb,
  reverbDb: reverbDb,
  comp2TargetDb: comp2TargetDb,
  satAmount: satAmount,
  comp2Touched: comp2Touched,
  satTouched: satTouched,
  reverbManuallySet: reverbManuallySet,
  mode: 'preview'
});

// â˜… å®Ÿéš›ã«FormDataã«è¿½åŠ ã•ã‚Œã‚‹å€¤ã‚’ç¢ºèªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰â˜…
console.log('[Test] FormData entries to be sent:');
if (typeof comp2TargetDb === 'number' && comp2Touched) {
  console.log('  comp2_offset_db will be sent:', comp2TargetDb);
} else {
  console.log('  comp2_offset_db will NOT be sent (not touched or invalid)');
}
if (typeof satAmount === 'number' && satTouched) {
  console.log('  sat_amount will be sent:', satAmount);
} else {
  console.log('  sat_amount will NOT be sent (not touched or invalid)');
}
console.log('  delay_offset_db will be sent:', delayDb);
console.log('  reverb_offset_db will be sent:', reverbDb);

// Enterã§ç¢ºå®šã—ãŸæ™‚ã ã‘é€ã‚‹
const b = getBpmCommitted();
if (b !== null) fd.append('bpm', String(b));

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCompé‡ã‚’è§¦ã£ãŸæ™‚ã ã‘é€ã‚‹
if (comp2Touched && typeof comp2TargetDb === 'number') {
  // ç›¸å¯¾ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤ã¨ã—ã¦é€ä¿¡ï¼ˆ-3/0/+3ï¼‰
  fd.append('comp2_offset_db', String(comp2TargetDb)); // -3 / 0 / +3
}

// â–¼ ã“ã“ã«è¿½åŠ ï¼šSaturation é‡ï¼ˆè§¦ã£ãŸæ™‚ã ã‘ï¼‰
if (satTouched && typeof satAmount === 'number') {
  fd.append('sat_amount', String(satAmount)); // ä¾‹ï¼š0.2 / 0.4 / 0.7
  console.log(`[Debug] Sending sat_amount to preview: ${satAmount}`);
} else {
  console.log(`[Debug] Preview saturation not sent: touched=${satTouched}, amount=${satAmount}`);
}

// æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
fd.append('delay_offset_db',  String(delayDb));
fd.append('reverb_offset_db', String(reverbDb));

console.log('[Debug] Reverb settings - style:', style, 'reverbDb:', reverbDb);

// ä»¥ä¸‹ã‚’è¿½åŠ 
const currentStyle = (style || '').toLowerCase();
const isChorusStyle = currentStyle === 'chorus' || currentStyle === 'chorus_wide';
if (isChorusStyle) {
  fd.append('enable_doubler', '1');
  console.log('[Debug] Doubler enabled for style:', style);
} else {
  fd.append('enable_doubler', '0');
  console.log('[Debug] Doubler disabled for style:', style);
}
  // Chorus ç³»ã‚„ï¼ˆå°†æ¥ã®ï¼‰ãƒ€ãƒ–ãƒ©ãƒ¼æœ‰åŠ¹æ™‚ã®ã¿ã‚¹ãƒ†ãƒ¬ã‚ªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  fd.append('force_stereo', shouldForceStereoPreview() ? '1' : '0');

try{
    // é€²æ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€é©åŒ–
    const isInitialLoad = lastProcessedBpm === null;
    const showDetailedProgress = isInitialLoad || bpmJustChanged;

    if (showDetailedProgress) {
      await setStatusWithDelay('ãƒ‰ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³é©ç”¨ä¸­...', 100);
      await setStatusWithDelay('ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‡¦ç†ä¸­...', 120);
      
      // BPMå¤‰æ›´æ™‚ã®ã¿ãƒ‡ã‚£ãƒ¬ã‚¤åŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (bpmJustChanged) {
        await setStatusWithDelay('ãƒ‡ã‚£ãƒ¬ã‚¤åŒæœŸä¸­...', 100);
      }
    } else {
      // é€šå¸¸ã®æ›´æ–°æ™‚ã¯ç°¡æ½”ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      await setStatusWithDelay('å‡¦ç†ä¸­...', 80);
    }
    
    const res = await fetch('/process', { 
      method:'POST', 
      body: fd, 
      cache:'no-store', 
      signal: prevCtl.signal 
    });
    
    if(!res.ok){ 
      status.textContent = `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•— (${res.status})`; 
      return; 
    }

    if (showDetailedProgress) {
      await setStatusWithDelay('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...', 50);
    }
    
    updateGlanceHeaders(res.headers);

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);

    if (lastObjectUrl) { try { URL.revokeObjectURL(lastObjectUrl); } catch {} lastObjectUrl = null; }

    if (showDetailedProgress) {
      await setStatusWithDelay('éŸ³å£°ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...', 50);
    }
    
    audioEl.removeAttribute('src');
    audioEl.src = url;
    audioEl.load();
    lastObjectUrl = url;

    window.updatePreviewBtnByState?.();
    
    // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€é©åŒ–
    const committed = getBpmCommitted();
    if (bpmJustChanged && committed !== null) {
      status.textContent = `BPM ${committed} åŒæœŸå®Œäº†ï¼å†ç”Ÿãƒœã‚¿ãƒ³ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    } else if (isInitialLoad) {
      const bpmLabel = (committed !== null) ? `BPM ${committed}` : 'ã‚¹ã‚¿ã‚¤ãƒ«æ¨™æº–';
      status.textContent = `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†ï¼ˆ${bpmLabel}ï¼‰ã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    } else {
      status.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°å®Œäº†';
    }

    // â˜… ã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ™‚ã®å‡¦ç† â˜…
    if (isInitialLoad) {
      updateProgress(100, 'âœ¨ å‡¦ç†å®Œäº†ï¼', 'ğŸ‰ æº–å‚™å®Œäº†', 5);
      await new Promise(resolve => setTimeout(resolve, 800)); // å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      hideProgress();
      enableAllSections();
    }
    // ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´æ™‚ã®ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆè§£é™¤ã¯smartPreviewUpdateã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡Œã‚ãªã„

    // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    lastProcessedBpm = committed;
    bpmJustChanged = false;

  } catch (e) {
    if (e.name === 'AbortError') return; // å¤ã„è¦æ±‚ã¯é»™ã£ã¦æ¨ã¦ã‚‹
    console.error(e);
    status.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    bpmJustChanged = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒªã‚»ãƒƒãƒˆ
  } finally {
    preview.disabled = false; 
    download.disabled = false;
    prevCtl = null;
    // äºŒé‡å‘¼ã³ã‚’è§£æ¶ˆï¼šã“ã“ã§ã¯ fetchAndRenderFxList() ã‚’å‘¼ã°ãªã„
  }
}

// æ”¹å–„: FXãƒˆã‚°ãƒ«æ™‚ã®å³åº§æ›´æ–°æ©Ÿèƒ½ä»˜ã
async function toggleFxAndUpdate(key, btn) {
  // 1) çŠ¶æ…‹ã ã‘åˆ‡ã‚Šæ›¿ãˆï¼ˆé€ä¿¡ã¯å¾Œã§ã¾ã¨ã‚ã‚‹ï¼‰
  fxOn[key] = !fxOn[key];

  // 2) ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã¯å³æ™‚åæ˜ ï¼ˆDOMã®å†æ§‹ç¯‰ã¯ã—ãªã„ï¼‰
  if (btn) {
    btn.textContent = fxOn[key] ? 'ON' : 'OFF';
    btn.style.background = fxOn[key] ? '#1e3a8a' : '#222';
    btn.style.color = fxOn[key] ? '#fff' : '#aaa';
  }

  // 3) è»½ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
  const status = document.getElementById('status');
  if (status) status.textContent = `${key} ã‚’${fxOn[key] ? 'ON' : 'OFF'} ã«ã—ã¾ã—ãŸ`;

  // 4) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã ã‘ã‚’ãƒ‡ãƒã‚¦ãƒ³ã‚¹å®Ÿè¡Œï¼ˆ/inspectã¯å‘¼ã°ãªã„ï¼‰
  clearTimeout(fxUpdateTimer);
  fxUpdateTimer = setTimeout(() => {
    // schedulePreview ã¯å†…éƒ¨ã§ in-flight ã‚’ç•³ã¿è¾¼ã‚€å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
    schedulePreview();  // await ã—ãªã„
  }, 120);
}

// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€æ‹¬ã‚ªãƒ³ã‚ªãƒ•æ©Ÿèƒ½
async function toggleAllEffects(turnOn) {
  const status = document.getElementById('status');
  if (status) status.textContent = `å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’${turnOn ? 'ON' : 'OFF'}ã«ã—ã¦ã„ã¾ã™...`;

  // å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’å¤‰æ›´
  Object.keys(fxOn).forEach(key => {
    fxOn[key] = turnOn;
  });

  // UIä¸Šã®å€‹åˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
  const fxButtons = document.querySelectorAll('.fx-toggle');
  fxButtons.forEach(btn => {
    btn.textContent = turnOn ? 'ON' : 'OFF';
    btn.style.background = turnOn ? '#1e3a8a' : '#222';
    btn.style.color = turnOn ? '#fff' : '#aaa';
  });

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
  await schedulePreview();

  if (status) status.textContent = `å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’${turnOn ? 'ON' : 'OFF'}ã«ã—ã¾ã—ãŸ`;
}

// ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€è¦§ï¼ˆON/OFFãƒˆã‚°ãƒ«ä»˜ãï¼‰
async function fetchAndRenderFxList(){
  const wrap = document.getElementById('fx_items');
  if (!wrap) { console.error('#fx_items ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  // æ—¢å­˜ã®é–‹é–‰çŠ¶æ…‹ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒ
  const openSet = new Set(Array.from(wrap.querySelectorAll('details[open]')).map(d => d.dataset.key));
  const prevScroll = wrap.scrollTop;

  const fd = new FormData();
  fd.append('gender', gender);
  fd.append('style',  style);
  fd.append('noise_gate', noiseGate);
  fd.append('fx_on', JSON.stringify(fxOn));

  // Enterã§ç¢ºå®šã—ãŸæ™‚ã ã‘é€ã‚‹
  const b = getBpmCommitted();
  if (b !== null) fd.append('bpm', String(b));

  // è§¦ã£ãŸæ™‚ã ã‘é€ã‚‹ï¼ˆLA-2A ç›®æ¨™GR / Saturationé‡ï¼‰
  if (comp2Touched && typeof comp2TargetDb === 'number') {
    fd.append('comp2_target_gr_db', String(comp2TargetDb));
  }
  if (satTouched && typeof satAmount === 'number') {
    fd.append('sat_amount', String(satAmount)); // ä¾‹ï¼š0.2/0.4/0.7
  }

  // å€‹åˆ¥ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  fd.append('delay_offset_db',  String(delayDb));
  fd.append('reverb_offset_db', String(reverbDb));
  // ï¼ˆã“ã“ã¯ mode ãªã—ã§OKï¼‰

  // ç›´å‰ã® /inspect ã‚’ä¸­æ–­ã—ã¦æœ€æ–°ã ã‘æœ‰åŠ¹åŒ–
  if (inspectCtl) inspectCtl.abort();
  inspectCtl = new AbortController();

  // ã¾ãšã¯ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘ã¦ã‹ã‚‰ JSON åŒ–ï¼ˆå¤±æ•—æ™‚ã®åŸå› ç‰¹å®šãŒå®¹æ˜“ï¼‰
  let text;
  try {
    const res = await fetch('/inspect', { method:'POST', body:fd, cache:'no-store', signal:inspectCtl.signal });
    text = await res.text();
    if (!res.ok) throw new Error(`/inspect HTTP ${res.status}: ${text.slice(0,200)}`);
  } catch (e) {
    console.error('fetch /inspect error:', e);
    wrap.innerHTML = `<div style="color:#f88">/inspect å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>`;
    return;
  }

  let data;
  try {
    data = JSON.parse(text);
  } catch (e) {
    console.error('Invalid JSON from /inspect:', text);
    wrap.innerHTML = `<div style="color:#f88">/inspect ã®å¿œç­”ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }

  // ã‚µãƒ¼ãƒã¨ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚­ãƒ¼åã‚ºãƒ¬ã«å¯¾å¿œï¼ˆeffects / fx ã®ã©ã¡ã‚‰ã§ã‚‚OKï¼‰
  let effects = Array.isArray(data.effects) ? data.effects
             : Array.isArray(data.fx)      ? data.fx
             : [];
  if (!Array.isArray(effects)) effects = [];

  // å®‰å…¨ã«æç”»ï¼šparams ãŒç„¡ã„/ null ã®ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
  wrap.innerHTML = '';
  effects.forEach(eff => {
    if (!eff || !eff.name) return;
    if (!eff.params) return; // ç„¡åŠ¹ or è¡¨ç¤ºæƒ…å ±ãªã—ã¯éè¡¨ç¤º

    const key = eff.key || eff.name;

    const row = document.createElement('details');
    row.dataset.key = key;
    if (openSet.has(key)) row.setAttribute('open', '');
    row.style.marginBottom = '8px';

    // BPMåŒæœŸã®æ³¨è¨˜ï¼ˆDelayã®ã¿ï¼‰
    let syncInfo = '';
    if ((key === 'delay' || /delay/i.test(key)) && eff.params.delay_time_s !== undefined) {
      const committed = getBpmCommitted();
      const label = (committed === null) ? 'ã‚¹ã‚¿ã‚¤ãƒ«æ¨™æº–' : `${committed} BPM`;
      syncInfo = `<div style="font-size:0.8em;color:#10b981;margin-top:4px;">ğŸµ BPMåŒæœŸ: ${label}</div>`;
    }

    // è¦‹å‡ºã—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ã‚’å‰Šé™¤ï¼‰
    let effectIcon = '';
    if (key === 'style_eq') effectIcon = '';
    else if (key === 'saturation') effectIcon = '';

    row.innerHTML = `
      <summary style="cursor:pointer;display:flex;gap:8px;align-items:center;">
        <span style="font-weight:600;">${effectIcon}${eff.name}</span>
        <button type="button" class="fx-toggle" data-key="${key}"
          style="margin-left:auto;padding:2px 10px;border-radius:999px;font-size:.85rem;border:1px solid #444;
                 ${eff.enabled ? 'background:#1e3a8a;color:#fff' : 'background:#222;color:#aaa'}">
          ${eff.enabled ? 'ON' : 'OFF'}
        </button>
      </summary>
      ${syncInfo}
      <pre style="white-space:pre-wrap;background:#0d0d0d;border:1px solid #222;border-radius:10px;padding:10px;margin-top:6px;overflow:auto;max-height:220px;">${
        JSON.stringify(eff.params, null, 2)
      }</pre>
    `;
    wrap.appendChild(row);
  });

  // ãƒˆã‚°ãƒ«ã®ãƒ¯ã‚¤ãƒ¤ãƒªãƒ³ã‚°
  wrap.querySelectorAll('.fx-toggle').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const k = btn.dataset.key;
      await toggleFxAndUpdate(k, btn);
    });
  });

  wrap.scrollTop = prevScroll;
}

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ï¼šæœ€å¾Œã® ObjectURL ã‚’è§£æ”¾
window.addEventListener('beforeunload', () => {
  if (lastObjectUrl) { try { URL.revokeObjectURL(lastObjectUrl); } catch {}; lastObjectUrl = null; }
});

// ===== ç©ºé–“ï¼ˆDelay/Reverbï¼‰å€‹åˆ¥èª¿æ•´ï¼šUIã ã‘å…ˆè¡Œå®Ÿè£… =====
(function(){
  const appState = window.appState || (window.appState = {});
  appState.spaceMode = appState.spaceMode || 'linked';   // 'linked' | 'split'
  appState.spaceMasterDb = appState.spaceMasterDb ?? 0;  // -4 / 0 / +4
  appState.delayOffsetDb = appState.delayOffsetDb ?? 0;  // -4 / 0 / +4
  appState.reverbOffsetDb = appState.reverbOffsetDb ?? 0;

  const spaceToggle   = document.getElementById('space_toggle');        // æ—¢å­˜ï¼ˆãƒã‚¹ã‚¿ãƒ¼ï¼‰
  const delayToggle   = document.getElementById('delay_space_toggle');  // æ–°è¦ï¼ˆå€‹åˆ¥ï¼‰
  const reverbToggle  = document.getElementById('reverb_space_toggle'); // æ–°è¦ï¼ˆå€‹åˆ¥ï¼‰
  const modeBadge     = document.getElementById('space_mode_badge');
  const relinkBtn     = document.getElementById('space_relink_btn');
  const fileInput     = document.getElementById('file');

  if (!spaceToggle || !delayToggle || !reverbToggle) return;

  function setSegSelected(segEl, val){
    segEl.querySelectorAll('button[data-val]').forEach(btn=>{
      const selected = btn.dataset.val === String(val);
      if (selected) btn.setAttribute('aria-selected', 'true');
      else btn.removeAttribute('aria-selected');
    });
  }
  function segGetSelectedVal(segEl){
    const el = segEl.querySelector('button[aria-selected="true"]') || segEl.querySelector('button[data-val="0"]');
    return el ? el.dataset.val : "0";
  }
  function setDisabledForSeg(segEl, disabled){
    segEl.querySelectorAll('button').forEach(b=> b.disabled = !!disabled);
  }

  function updateLinkedFromMaster(){
    const v = segGetSelectedVal(spaceToggle);
    appState.spaceMasterDb = Number(v);
    if (appState.spaceMode === 'linked'){
      setSegSelected(delayToggle, v);
      setSegSelected(reverbToggle, v);
    }
  }

  function enterSplit(){
    if (appState.spaceMode === 'split') return;
    appState.spaceMode = 'split';
    if (modeBadge) modeBadge.textContent = 'å€‹åˆ¥èª¿æ•´ä¸­';
    if (relinkBtn) relinkBtn.hidden = false;
    setDisabledForSeg(delayToggle, false);
    setDisabledForSeg(reverbToggle, false);
    // ãƒã‚¹ã‚¿ãƒ¼ã¯æ“ä½œä¸å¯ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆæ‰±ã„ï¼‰
    setDisabledForSeg(spaceToggle, true);
  }

  function relink(){
    appState.spaceMode = 'linked';
    if (modeBadge) modeBadge.textContent = 'ãƒªãƒ³ã‚¯ä¸­';
    if (relinkBtn) relinkBtn.hidden = true;
    updateLinkedFromMaster();             // å€‹åˆ¥ã‚’ãƒã‚¹ã‚¿ãƒ¼å€¤ã«åˆã‚ã›ç›´ã™
    setDisabledForSeg(delayToggle, true); // å€‹åˆ¥ã¯ãƒ­ãƒƒã‚¯
    setDisabledForSeg(reverbToggle, true);
    setDisabledForSeg(spaceToggle, false);
  }

  // åˆæœŸåŒ–ï¼ˆãƒªãƒ³ã‚¯ä¸­ã«æˆ»ã™ï¼‰
  relink();

  // ãƒã‚¹ã‚¿ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆlinkedæ™‚ã®ã¿åæ˜ ï¼‰
  spaceToggle.addEventListener('click', (e)=>{
    const t = e.target.closest('button[data-val]');
    if (!t) return;
    if (appState.spaceMode === 'split') return; // å€‹åˆ¥èª¿æ•´ä¸­ã¯ç„¡åŠ¹
    // æ—¢å­˜ã®é¸æŠå‡¦ç†ãŒèµ°ã£ãŸå¾Œã«åæ˜ 
    setTimeout(()=>{
      updateLinkedFromMaster();
      if (typeof runPreviewIfPossible === 'function') runPreviewIfPossible();
    }, 0);
  });

  // å€‹åˆ¥ã‚’è§¦ã£ãŸã‚‰ split ã¸
  [delayToggle, reverbToggle].forEach(seg=>{
    seg.addEventListener('click', (e)=>{
      const t = e.target.closest('button[data-val]');
      if (!t) return;
      enterSplit();
      setTimeout(()=>{
        appState.delayOffsetDb  = Number(segGetSelectedVal(delayToggle));
        appState.reverbOffsetDb = Number(segGetSelectedVal(reverbToggle));
        if (typeof runPreviewIfPossible === 'function') runPreviewIfPossible();
      }, 0);
    });
  });

  // ã€Œãƒªãƒ³ã‚¯ã«æˆ»ã™ã€
  if (relinkBtn) relinkBtn.addEventListener('click', ()=>{
    relink();
    if (typeof runPreviewIfPossible === 'function') runPreviewIfPossible();
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸ã³ç›´ã—ã§è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
  if (fileInput) fileInput.addEventListener('change', ()=>{ relink(); });

  // ï¼ˆå°†æ¥ã®çµç·šç”¨ï¼‰ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å–å¾—ã—ãŸã„å ´åˆã«å‚™ãˆã¦å…¬é–‹
  window.getSpaceParams = function(){
    return {
      space_mode: appState.spaceMode,
      space_master_db: appState.spaceMasterDb,
      delay_offset_db: appState.delayOffsetDb,
      reverb_offset_db: appState.reverbOffsetDb,
    };
  };
})();
